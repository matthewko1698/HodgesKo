<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <script type="text/javascript" src='d3.js'>

    </script>
  </head>
  <body>
    <svg>
    </svg>
    <p class="day">Day: --</p>
    <button type="button" name="p" class='p'>Prev</button>
    <button type="button" name="n" class ='n'>Next</button>
  </body>
  <script type="text/javascript">

    var data = d3.json('gradeDataTime.json').then(function(data){

        initialize(data);
        buttonUpdate(data,-1,0);
    })

    var initialize = function(data){

      var svgwidth = 1200;
      var svgheight = 700;

      var svg = d3.select('svg').attr('width',svgwidth).attr('height',svgheight);
      var margins =
      {
        top:20,
        bottom:50,
        left:50,
        right:100
      }

      var width = svgwidth -margins.left - margins.right;
      var height = svgheight -margins.top - margins.bottom;

      var yScale = d3.scaleLinear()
                     .domain([0,100])
                     .range([height,0]);

      var yAxis = d3.axisLeft(yScale);
      svg.append('g').classed('yScale',true)
         .call(yAxis)
         .attr('transform','translate('+(margins.left+10)+","+margins.top+')')

      var barWidth= width/5;

      var colors = d3.scaleOrdinal(d3.schemeSet1);

      var plot = svg.append('g').classed('plot',true)
              .attr('transform','translate('+margins.left+","+margins.top+")");

      var rect = plot.selectAll('.rects')
                     .data( data[0].grades)
                     .enter()
                     .append('rect')
                     .classed('rect',true)
                     .attr('x', function(d,i){

                       return i*(width/4)+margins.left;
                     })
                     .attr('y',height/2)
                     .attr('width',barWidth)
                     .attr('height',function(d){
                       return height/2;
                     })
                     .attr('fill',function(d){
                       return colors(d.name)
                     });

     var change = plot.selectAll('.change')
                    .data( data[0].grades)
                    .enter()
                    .append('rect')
                    .classed('change',true)
                    .attr('x', function(d,i){
                      return i*(width/4)+margins.left;
                    })
                    .attr('y',height/2)
                    .attr('width',barWidth)
                    .attr('height',0)
                    .attr('fill','grey');

      var textBox = plot.selectAll('text')
                      .data(data[0].grades)
                      .enter()
                      .append('text')
                      .attr('x',function(d,i){
                        return i *(width/4)+margins.left+45;
                      })
                      .attr('y',height/2+30)
                      .text(function(d){
                        return d.grade;
                      })
                      .classed('grades',true)
                      .attr('fill',function(d){
                        return 'white';
                      })
                      .style('visibility','hidden');

      rect.on("mouseover",function(){
        d3.select(this)
           .attr("fill","black");

        d3.selectAll('.grades')
          .style('visibility','visible')

      })
      .on('mouseout',function(d){
        d3.select(this)
           .attr("fill",colors(d.name));
        d3.selectAll('.grades')
          .style('visibility','hidden');
      });

      var names = plot.selectAll('.names').data(data[0].grades)
                      .enter()
                      .append('text')
                      .attr('x',function(d,i){
                        return i*(width/4)+margins.left+barWidth/3;
                      })
                      .attr('y',height+margins.bottom/3)
                      .text(function(d){
                        return d.name;
                      });


    }

    var update = function(d,day,pday){
        var svgwidth = 1200;
        var svgheight = 700;
        var margins =
        {
          top:20,
          bottom:50,
          left:50,
          right:100
        }

        var width = svgwidth -margins.left - margins.right;
        var height = svgheight -margins.top - margins.bottom;

        var svg = d3.select('svg');

        var yScale = d3.scaleLinear()
                       .domain([0,100])
                       .range([height,0]);

        svg.selectAll('.rect').data( d[day].grades ).transition()
                     .duration(1000)
                     .attr('height',function(d){
                       return d.grade*height/100;
                     })
                     .attr('y',function(d){

                      return height-d.grade*height/100;

                    });

        svg.selectAll('.grades').data( d[day].grades )
           .transition()
           .duration(1000)
           .attr('y',function(d){
             if((height-d.grade*height/100+30)>height)
                {return height;}
             else{return height-d.grade*height/100+30}
           })
           .text(function(d){
             return d.grade;
           });


        console.log(day);
        d3.select('.day').text('Day: '+(day+1));
        buttonUpdate(d,day);

    }

    var buttonUpdate = function(data,day){

      d3.select('.p').on('click',function(){
           update(data,day-1,day);
      })

      d3.select('.n').on('click',function(){
          update(data,day+1,day);
      })

    }

  </script>
</html>
